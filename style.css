import React, { useState, useEffect } from "react";
import "./style.css";

export default function App() {
  const [user, setUser] = useState(null);
  const [schedule, setSchedule] = useState(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");
  const [now, setNow] = useState(new Date());

  // üïí Recalculate live hours every minute
  useEffect(() => {
    const timer = setInterval(() => setNow(new Date()), 60000);
    return () => clearInterval(timer);
  }, []);

  // üßÆ Calculate live/active shift hours
  function calcLiveHours(shift, hours) {
    if (!shift) return 0;
    if (shift.includes("-")) return hours || 0;

    // If shift ends with "." ‚Üí active shift
    const match = shift.match(/(\d{1,2})(?::(\d{2}))?/);
    if (!match) return hours || 0;

    const startHour = parseInt(match[1], 10);
    const startMin = parseInt(match[2] || "0", 10);

    const now = new Date();
    const start = new Date(now);
    start.setHours(startHour);
    start.setMinutes(startMin);

    let diff = (now - start) / 3600000; // ms ‚Üí hours
    if (diff < 0) diff += 24; // midnight correction

    return Math.round(diff * 10) / 10; // round to 0.1h
  }

  // üß© Handle login
  async function handleLogin(e) {
    e.preventDefault();
    const email = e.target.email.value.trim();
    const password = e.target.password.value.trim();
    setLoading(true);
    setError("");

    try {
      const res = await fetch(
        `https://script.google.com/macros/s/AKfycbw8qIYHFAkLKq5zDbjhAkmFyHPaR9Ib01C32gP3uRo1m3dVYjD/exec?action=login&email=${email}&password=${password}`
      );
      const data = await res.json();

      if (!data.ok) throw new Error("Invalid email or password");
      setUser(data);
      fetchSchedule(email);
    } catch (err) {
      setError(err.message);
    } finally {
      setLoading(false);
    }
  }

  // üìÖ Fetch schedule
  async function fetchSchedule(email) {
    setLoading(true);
    try {
      const res = await fetch(
        `https://script.google.com/macros/s/AKfycbw8qIYHFAkLKq5zDbjhAkmFyHPaR9Ib01C32gP3uRo1m3dVYjD/exec?action=getSmartSchedule&email=${email}`
      );
      const data = await res.json();
      if (data.ok) setSchedule(data);
      else setError("Could not load schedule");
    } catch (err) {
      setError("Network error");
    } finally {
      setLoading(false);
    }
  }

  // üö™ Logout
  function handleLogout() {
    setUser(null);
    setSchedule(null);
  }

  // üßÆ Calculate total including live hours
  function calcTotalWithLive(days) {
    return days.reduce((sum, d) => {
      const live = calcLiveHours(d.shift, d.hours);
      return sum + (live || 0);
    }, 0).toFixed(1);
  }

  // üñºÔ∏è Login screen
  if (!user) {
    return (
      <div className="container">
        <h1>ALLSTON CAR WASH</h1>
        <form onSubmit={handleLogin}>
          <input type="email" name="email" placeholder="Email" required />
          <input type="password" name="password" placeholder="Password" required />
          <button type="submit" disabled={loading}>
            {loading ? "Signing in..." : "Sign In"}
          </button>
        </form>
        {error && <p className="error">{error}</p>}
        <p className="footer">Powered by <b>JAG15</b> | Allston Car Wash ¬© 2025</p>
      </div>
    );
  }

  // üßæ Dashboard
  return (
    <div className="container">
      <h2>{schedule?.name || user.name}</h2>
      <p className="role">{user.role}</p>
      <p>Week of {schedule?.week}</p>
      <p>{schedule?.name}</p>

      <table>
        <thead>
          <tr>
            <th>Day</th>
            <th>Shift</th>
            <th>Hours</th>
          </tr>
        </thead>
        <tbody>
          {schedule?.days?.map((day, i) => {
            const today = new Date().toLocaleDateString("en-US", { weekday: "short" });
            const isToday = today === day.name;
            const live = calcLiveHours(day.shift, day.hours);
            const displayHours = isToday && day.shift.endsWith(".") ? live : day.hours;

            return (
              <tr key={i}>
                <td>{day.name}</td>
                <td>{day.shift || "-"}</td>
                <td>
                  {day.shift?.endsWith(".") && isToday ? (
                    <span>‚è±Ô∏è {displayHours}</span>
                  ) : (
                    displayHours
                  )}
                </td>
              </tr>
            );
          })}
        </tbody>
      </table>

      <p className="total">
        Total Hours: <b>{calcTotalWithLive(schedule.days)}</b>
      </p>
      <p className="clock">üïì {now.toLocaleTimeString()}</p>

      <div className="settings-box">
        <button onClick={handleLogout} className="logout">
          Log Out
        </button>
        <p className="footer">
          Powered by <b>JAG15</b> | Allston Car Wash ¬© 2025<br />
          v4.7 ‚Äî Live Blue Glass Edition
        </p>
      </div>
    </div>
  );
}
body {
  font-family: 'Segoe UI', sans-serif;
  background: #ffffff;
  margin: 0;
  padding: 0;
}

.container {
  text-align: center;
  background: rgba(255, 255, 255, 0.95);
  border-radius: 14px;
  padding: 40px 50px;
  margin: 60px auto;
  max-width: 420px;
  box-shadow: 0 0 35px rgba(0, 120, 255, 0.35); /* üîµ blue shadow */
  transition: all 0.4s ease;
}

h1, h2 {
  color: #c00;
  margin-bottom: 10px;
}

.role {
  color: #444;
  font-weight: bold;
  margin-top: -5px;
  margin-bottom: 10px;
}

table {
  width: 100%;
  border-collapse: collapse;
  margin: 20px 0;
}

th {
  color: #c00;
}

td, th {
  padding: 8px 4px;
  border-bottom: 1px solid #ddd;
}

.total {
  margin-top: 10px;
  font-weight: bold;
  color: #c00;
}

.clock {
  margin-top: 5px;
  color: #0070ff;
  font-size: 0.9em;
}

button {
  background: #c00;
  color: white;
  border: none;
  border-radius: 6px;
  padding: 10px 20px;
  cursor: pointer;
  margin-top: 15px;
}

button:hover {
  background: #a00;
}

.footer {
  margin-top: 20px;
  font-size: 0.85em;
  color: #555;
}

.error {
  color: #c00;
  margin-top: 10px;
}                              

              
